/**
 * AngularJS module to manage HTTP Digest Authentication
 * @version v0.4.3 - 2017-09-28
 * @link https://github.com/tafax/angular-digest-auth
 * @author Matteo Tafani Alunno <matteo.tafanialunno@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */

"use strict";var dgAuth=angular.module("dgAuth",["angular-md5","FSM"]);dgAuth.config(["$httpProvider",function(e){e.interceptors.push(["$q","authService","authClient","authServer","stateMachine",function(e,t,n,r,i){return{request:function(r){var i=t.getCredentials(),s=n.processRequest(i.username,i.password,r.method,r.url);return s&&(r.headers.Authorization=s),r||e.when(r)},responseError:function(n){if(401===n.status){if(!r.parseHeader(n))return e.reject(n);var s=e.defer();return t.setRequest(n.config,s),i.send("401",{response:n}),s.promise}return e.reject(n)}}}])}]),dgAuth.config(["stateMachineProvider",function(e){e.config({init:{transitions:{run:"restoringCredentials"}},restoringCredentials:{transitions:{restored:"settingCredentials"},action:["authStorage","params",function(e,t){return e.hasCredentials()&&(t.credentials={username:e.getUsername(),password:e.getPassword()}),t}]},settingCredentials:{transitions:{signin:"loginRequest"},action:["authService","params",function(e,t){if(t.hasOwnProperty("credentials")){var n=t.credentials;e.setCredentials(n.username,n.password)}}]},loginRequest:{transitions:{401:[{to:"waitingCredentials",predicate:["authService","authRequests",function(e,t){return!e.hasCredentials()&&t.getValid()}]},{to:"loginError",predicate:["authService","authRequests",function(e,t){return e.hasCredentials()&&t.getValid()}]},{to:"failureLogin",predicate:["authRequests",function(e){return!e.getValid()}]}],201:"loggedIn"},action:["authRequests",function(e){e.signin()}]},loginError:{transitions:{submitted:"settingCredentials"},action:["authService","params",function(e,t){e.clearCredentials();var n=e.getCallbacks("login.error");for(var r in n)(0,n[r])(t.response)}]},waitingCredentials:{transitions:{submitted:"settingCredentials"},action:["authService","authIdentity","authStorage","name","params",function(e,t,n,r,i){if("logoutRequest"==r){t.clear(),e.clearRequest(),e.clearCredentials(),n.clearCredentials();var s=e.getCallbacks("logout.successful");for(var o in s)(0,s[o])(i.response)}t.suspend(),e.clearCredentials(),n.clearCredentials();var a=e.getCallbacks("login.required");for(var u in a)(0,a[u])(i.response)}]},loggedIn:{transitions:{signout:"logoutRequest",401:"waitingCredentials"},action:["authService","authIdentity","authStorage","name","params",function(e,t,n,r,i){if("logoutRequest"==r){var s=e.getCallbacks("logout.error");for(var o in s)(0,s[o])(i.response)}if("loginRequest"==r){t.isSuspended()&&t.restore(),t.has()||t.set(null,i.response.data),e.clearRequest();var a=e.getCredentials();n.setCredentials(a.username,a.password);var u=e.getCallbacks("login.successful");for(var c in u)(0,u[c])(i.response)}}]},logoutRequest:{transitions:{401:"loggedIn",201:"waitingCredentials"},action:["authRequests",function(e){e.signout()}]},failureLogin:{action:["authService","authIdentity","params",function(e,t,n){t.clear(),e.clearCredentials();var r=e.getCallbacks("login.limit");for(var i in r)(0,r[i])(n.response)}]}})}]),dgAuth.provider("dgAuthService",function(){function e(e,t,n,r){var i=!1;this.start=function(){r.initialize(),r.send("run"),r.send("restored"),r.send("signin"),i=!0},this.signin=function(){if(!i)throw"You have to start the service first";r.send("signin")},this.signout=function(){if(!i)throw"You have to start the service first";r.send("signout")},this.setCredentials=function(e,t){if(!i)throw"You have to start the service first";r.send("submitted",{credentials:{username:e,password:t}})},this.isAuthorized=function(){var r=e.defer();return n.getPromise().then(function(){r.resolve(t.has())},function(){r.reject(t.has())}),r.promise}}var t=window.sessionStorage;this.setStorage=function(e){t=e},this.getStorage=function(){return t};var n={login:{method:"POST",url:"/signin"},logout:{method:"POST",url:"/signout"}};this.setConfig=function(e){angular.extend(n,e)},this.getConfig=function(){return n};var r=4;this.setLimit=function(e){r=e},this.getLimit=function(){return r},this.callbacks={login:[],logout:[]};var i="";this.setHeader=function(e){i=e},this.getHeader=function(){return i},this.$get=["$q","authIdentity","authRequests","stateMachine",function(t,n,r,i){return new e(t,n,r,i)}]}),dgAuth.factory("authClient",["authServer","md5",function(e,t){return new function(){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=0,i=function(e){for(var t=[],r=n.length,i=0;i<e;++i)t.push(n[Math.random()*r|0]);return t.join("")},s=function(){for(var e=8-(++r).toString().length,t="",n=0;n<e;n++)t+="0";return t+r},o=function(n,r,i,s,o,a){var u=t.createHash(n+":"+e.info.realm+":"+r),c=t.createHash(i+":"+s);return t.createHash(u+":"+e.info.nonce+":"+o+":"+a+":"+e.info.qop+":"+c)},a=function(t,n,r,a){var u=s(),c=i(16);return'Digest username="'+t+'", realm="'+e.info.realm+'", nonce="'+e.info.nonce+'", uri="'+a+'", algorithm="'+e.info.algorithm+'", response="'+o(t,n,r,a,u,c)+'", opaque="'+e.info.opaque+'", qop="'+e.info.qop+'", nc="'+u+'", cnonce="'+c+'"'};this.isConfigured=function(){return e.isConfigured()},this.processRequest=function(t,n,r,i){var s=null;return this.isConfigured()&&i.indexOf(e.info.domain)>=0&&(s=a(t,n,r,i)),s}}}]),dgAuth.factory("authIdentity",function(){return new function(){var e=null,t=!1;this.set=function(n,r){if(!t)if(n)null==e&&(e={}),e[n]=r;else{if(!(r instanceof Object))throw"You have to provide an object if you want to set the identity without a key.";e=r}},this.get=function(n){return t?null:n?e&&e.hasOwnProperty(n)?e[n]:null:e},this.has=function(){return!t&&null!==e},this.clear=function(){e=null},this.suspend=function(){t=!0},this.restore=function(){t=!1},this.isSuspended=function(){return t}}}),dgAuth.constant("_g",function(e){return"("+e+")"}),dgAuth.constant("_seq",function(){return Array.prototype.join.call(arguments,"")}),dgAuth.constant("_alt",function(){return"(?:"+Array.prototype.join.call(arguments,"|")+")"}),dgAuth.constant("_tokenRx","[!#-'*+.0-9A-Z^-z|~-]+"),dgAuth.factory("_quotedRx",["_alt",function(e){return'"'+e('\\\\"','[^"\\\\]+')+'*"'}]),dgAuth.factory("_paramRx",["_seq","_g","_tokenRx","_alt","_quotedRx",function(e,t,n,r,i){return e(t(n),"=",t(r(i,n)),"\\s*")}]),dgAuth.constant("_dequote",function(e){return'"'!==e.charAt(0)?e:e.slice(1,-1).replace(/\\(.)/g,"$1")}),dgAuth.factory("parseChallenge",["_paramRx","_tokenRx","_dequote",function(e,t,n){var r=new RegExp("^"+t);return e=new RegExp("^"+e),function(t,i){try{if(null===t)throw"challenge string is null";var s=t.match(r);if(!s)throw"expected scheme token at pos 0";var o=s[0],a=o.length;if(t=t.substr(a),!(s=t.match("^ +")))throw"expected space delimiter following scheme at pos "+a;a+=s[0].length;for(var u=t.substr(s[0].length);;){if(!(s=u.match(e)))throw"expected parameter expression at pos "+a+" of "+u;if(i[s[1]]=n(s[2]),u=u.substr(s[0].length),a+=s[0].length,0===u.length)break;if(!(s=u.match(/^, */)))throw"expected comma delimiter at pos "+a;u=u.substr(s[0].length),a+=s[0].length}return o}catch(e){throw"Whilst parsing WWW-Authenticate challenge: "+t+"\n"+e}}}]),dgAuth.provider("authServer",["dgAuthServiceProvider",function(e){this.$get=["authStorage","parseChallenge","$log",function(t,n,r){var i=new function(e,t){var i=e,s=!1;this.info={realm:"",domain:"",nonce:"",opaque:"",algorithm:"",qop:""},this.isConfigured=function(){return s},this.setConfig=function(e){angular.extend(this.info,e),s=!0},this.parseHeader=function(e){s=!1;var o=e.headers(i);try{n(o,this.info)}catch(e){return r.error(e),s}return t.setServerAuth(this.info),s=!0}}(e.getHeader(),t);return t.hasServerAuth()&&i.setConfig(t.getServerAuth()),i}]}]),dgAuth.provider("authService",["dgAuthServiceProvider",function(e){function t(e,t){var n="",r="";this.setCredentials=function(e,t){n=e.trim(),r=t.trim()},this.getCredentials=function(){return{username:n,password:r}},this.hasCredentials=function(){return""!==n.trim()&&""!==r.trim()},this.clearCredentials=function(){n="",r=""};var i=null;this.setRequest=function(e,t){i={config:e,deferred:t}},this.getRequest=function(){return i},this.hasRequest=function(){return null!==i},this.clearRequest=function(){i=null},this.getCallbacks=function(n){var r=n.split(".");if(r.length>2||0==r.length)throw"The type for the callbacks is invalid.";var i=r[0],s=2==r.length?r[1]:null,o=[];if(e.hasOwnProperty(i)){var a=e[i];for(var u in a){var c=t.invoke(a[u]);s?c.hasOwnProperty(s)&&o.push(c[s]):o.push(c)}}return o}}this.$get=["$injector",function(n){return new t(e.callbacks,n)}]}]),dgAuth.provider("authRequests",["dgAuthServiceProvider",function(e){function t(e,t,n,r,i){var s=null;this.getPromise=function(){return s};var o=0;this.getValid=function(){return"inf"==e||o<=e};var a=function(){var e=null;if(r.hasRequest()){var t=r.getRequest();e=n(t.config).then(function(e){return t.deferred.resolve(e),o>0&&(o=0),i.isAvailable("201")&&i.send("201",{response:e}),e},function(e){return t.deferred.reject(e),o>0&&(o=0),i.isAvailable("failure")&&i.send("failure",{response:e}),e})}return e};this.signin=function(){return o++,(s=a())?s:s=n(t.login).then(function(e){return o=0,i.send("201",{response:e}),e},function(e){return o=0,i.send("failure",{response:e}),e})},this.signout=function(){return(s=a())?s:s=n(t.logout).then(function(e){return i.send("201",{response:e}),e},function(e){return e})}}this.$get=["$http","authService","stateMachine",function(n,r,i){return new t(e.getLimit(),e.getConfig(),n,r,i)}]}]),dgAuth.provider("authStorage",["dgAuthServiceProvider",function(e){function t(e){var t=e,n=window.sessionStorage;this.hasCredentials=function(){var e=t.getItem("username"),n=t.getItem("password");return null!==e&&null!==n&&void 0!==e&&void 0!==n},this.setCredentials=function(e,n){t.setItem("username",e),t.setItem("password",n)},this.clearCredentials=function(){t.removeItem("username"),t.removeItem("password")},this.hasServerAuth=function(){var e=n.getItem("server");return null!==e&&void 0!==e},this.setServerAuth=function(e){n.setItem("server",angular.toJson(e))},this.getServerAuth=function(){return angular.fromJson(n.getItem("server"))},this.getUsername=function(){return t.getItem("username")},this.getPassword=function(){return t.getItem("password")},this.clear=function(){t.clear(),n.clear()}}this.$get=function(){return new t(e.getStorage())}}]);